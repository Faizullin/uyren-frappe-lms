import{J as N,K as z,r as C,i as R,o as O,A as x,b6 as F,e as p,f as i,k,j as D,h as c,g as s,n as T,l as e,a1 as W,_ as S,t as m,F as q,x as L,aF as A,b7 as X,b8 as Y,p as B,aG as U,C as H,H as G,L as Z,q as ee,b9 as J,M as te,ba as se,N as oe}from"./index-DcFDtKzU.js";import{_ as K}from"./UserAvatar-CrXqRFgS.js";const ae={class:"mt-6"},ne={key:0,class:"flex items-center mb-5"},le={class:"text-lg font-semibold ml-2 text-ink-gray-9"},re={class:"flex items-center justify-between mb-2"},ie={class:"flex items-center text-ink-gray-5"},de={class:"text-sm ml-2"},ce={key:1},ue={key:2,class:"flex justify-between mt-2"},j={__name:"DiscussionReplies",props:N({topic:{type:Object,required:!0},singleThread:{type:Boolean,default:!1}},{showTopics:{},showTopicsModifiers:{}}),emits:["update:showTopics"],setup(l){const g=z(l,"showTopics"),y=C(""),o=R("$socket"),w=R("$user"),h=R("$allUsers"),$=C([]),a=C(!1),d=window.read_only_mode,n=l;O(()=>{o.on("publish_message",t=>{v.reload()}),o.on("update_message",t=>{v.reload()}),o.on("delete_message",t=>{v.reload()}),f()});const v=x({url:"lms.lms.utils.get_discussion_replies",cache:["replies",n.topic],makeParams(t){return{topic:n.topic.name}},auto:!0}),P=x({url:"frappe.client.insert",makeParams(t){return{doc:{doctype:"Discussion Reply",reply:y.value,topic:n.topic.name}}}}),f=()=>{w.data?.is_student?a.value=!0:h.reload({},{onSuccess(t){$.value=Object.values(t).map(b=>({value:b.name,label:b.full_name})),a.value=!0}})},_=()=>{P.submit({},{validate(){if(!y.value)return"Reply cannot be empty"},onSuccess(){y.value="",v.reload()},onError(t){G.error(t.messages?.[0]||t)}})},u=x({url:"frappe.client.set_value",makeParams(t){return{doctype:"Discussion Reply",name:t.name,fieldname:"reply",value:t.reply}}}),V=t=>{u.submit({name:t.name,reply:t.reply},{validate(){if(!t.reply)return"Reply cannot be empty"},onSuccess(){t.editable=!1,v.reload()}})},E=x({url:"frappe.client.delete",makeParams(t){return{doctype:"Discussion Reply",name:t.name}}}),I=t=>{E.submit({name:t.name},{onSuccess(){v.reload()}})};return F(()=>{o.off("publish_message"),o.off("update_message"),o.off("delete_message")}),(t,b)=>(i(),p("div",ae,[l.singleThread?k("",!0):(i(),p("div",ne,[c(e(S),{variant:"outline",onClick:b[0]||(b[0]=r=>g.value=!0)},{icon:T(()=>[c(e(W),{class:"w-5 h-5 stroke-1.5 text-ink-gray-7"})]),_:1}),s("span",le,m(l.topic.title),1)])),(i(!0),p(q,null,L(e(v).data,(r,Q)=>(i(),p("div",null,[s("div",{class:H(["py-3",{"border-b":Q+1!=e(v).data.length}])},[s("div",re,[s("div",ie,[c(K,{user:r.user,class:"mr-2"},null,8,["user"]),s("span",null,m(r.user.full_name),1),s("span",de,m(e(A)(r.creation)),1)]),e(w).data.name==r.owner&&!r.editable&&!e(d)?(i(),D(e(Y),{key:0,options:[{label:"Edit",onClick(){r.editable=!0}},{label:"Delete",onClick(){I(r)}}]},{default:T(({open:M})=>[c(e(X),{class:"w-4 h-4 stroke-1.5 cursor-pointer"})]),_:2},1032,["options"])):k("",!0),r.editable?(i(),p("div",ce,[c(e(S),{variant:"ghost",onClick:M=>V(r)},{default:T(()=>[B(m(t.__("Post")),1)]),_:2},1032,["onClick"]),c(e(S),{variant:"ghost",onClick:M=>r.editable=!1},{default:T(()=>[B(m(t.__("Discard")),1)]),_:2},1032,["onClick"])])):k("",!0)]),c(e(U),{content:r.reply,onChange:M=>r.reply=M,editable:r.editable||!1,fixedMenu:r.editable||!1,editorClass:r.editable?"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-outline-gray-2 prose-th:border-outline-gray-2 prose-td:relative prose-th:relative prose-th:bg-surface-gray-2 prose-sm max-w-none":"prose-sm"},null,8,["content","onChange","editable","fixedMenu","editorClass"])],2)]))),256)),a.value&&!e(d)?(i(),D(e(U),{key:1,class:"mt-5",content:y.value,mentions:$.value,onChange:b[1]||(b[1]=r=>y.value=r),placeholder:"Type your reply here...",fixedMenu:!0,editorClass:"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-outline-gray-2 prose-th:border-outline-gray-2 prose-td:relative prose-th:relative prose-th:bg-surface-gray-2 prose-sm max-w-none border border-outline-gray-2 rounded-b-md min-h-[7rem] py-1 px-2"},null,8,["content","mentions"])):k("",!0),e(d)?k("",!0):(i(),p("div",ue,[b[3]||(b[3]=s("span",null,null,-1)),c(e(S),{onClick:b[2]||(b[2]=r=>_())},{default:T(()=>[s("span",null,m(t.__("Post")),1)]),_:1})]))]))}},pe={class:"flex flex-col gap-4"},me={class:"mb-1.5 text-sm text-ink-gray-5"},fe={__name:"DiscussionModal",props:N({title:{type:String,required:!0},doctype:{type:String,required:!0},docname:{type:String,required:!0}},{reloadTopics:{},reloadTopicsModifiers:{}}),emits:["update:reloadTopics"],setup(l){const g=z(l,"reloadTopics"),y=l,o=Z({title:"",reply:""}),w=x({url:"frappe.client.insert",makeParams(a){return{doc:{doctype:"Discussion Topic",reference_doctype:y.doctype,reference_docname:y.docname,title:o.title}}}}),h=x({url:"frappe.client.insert",makeParams(a){return{doc:{doctype:"Discussion Reply",topic:a.topic,reply:o.reply}}}}),$=a=>{w.submit({},{validate(){if(!o.title)return"Title cannot be empty.";if(!o.reply)return"Reply cannot be empty."},onSuccess(d){h.submit({topic:d.name},{onSuccess(){o.title="",o.reply="",g.value.reload(),a()}})},onError(d){G.error(d.messages?.[0]||d)}})};return(a,d)=>(i(),D(e(te),{options:{title:e(J)(y.title),size:"2xl",actions:[{label:"Post",variant:"solid",onClick:n=>$(n)}]}},{"body-content":T(()=>[s("div",pe,[s("div",null,[c(e(ee),{modelValue:o.title,"onUpdate:modelValue":d[0]||(d[0]=n=>o.title=n),label:a.__("Title"),type:"text"},null,8,["modelValue","label"])]),s("div",null,[s("div",me,m(a.__("Details")),1),c(e(U),{content:o.reply,onChange:d[1]||(d[1]=n=>o.reply=n),editable:!0,fixedMenu:!0,editorClass:"prose-sm max-w-none border-b border-x bg-surface-gray-2 rounded-b-md py-1 px-2 min-h-[7rem]"},null,8,["content"])])])]),_:1},8,["options"]))}};function ye(){return window.scrollContainer}const be={class:"text-xl font-semibold text-ink-gray-9"},ve={key:0},_e=["onClick"],ge={class:"text-lg font-semibold mb-1 text-ink-gray-7"},he={class:"flex items-center text-ink-gray-5"},ke={class:"text-sm ml-3"},Te={key:1},xe={key:1},we={key:2,class:"flex flex-col items-center justify-center border-2 border-dashed mt-5 py-8 rounded-md"},$e={class:""},Ce={key:0,class:"font-medium mb-2"},Se={class:"text-ink-gray-5"},De={__name:"Discussions",props:{title:{type:String,required:!0},doctype:{type:String,required:!0},docname:{type:String,required:!0},emptyStateTitle:{type:String,default:""},emptyStateText:{type:String,default:"Start a discussion"},singleThread:{type:Boolean,default:!1},scrollToBottom:{type:Boolean,default:!1}},setup(l){const g=C(!0),y=C(null),o=R("$socket"),w=R("$user"),h=C(!1),$=window.read_only_mode,a=l;O(()=>{w.data&&n.reload(),o.on("new_discussion_topic",f=>{n.refresh()}),a.scrollToBottom&&setTimeout(()=>{d()},100)});const d=()=>{let f=ye();f.scrollTop=f.scrollHeight},n=x({url:"lms.lms.utils.get_discussion_topics",cache:["topics",a.doctype,a.docname],makeParams(){return{doctype:a.doctype,docname:a.docname,single_thread:a.singleThread}}}),v=f=>{g.value=!1,y.value=f},P=()=>{h.value=!0};return F(()=>{o.off("new_discussion_topic")}),(f,_)=>(i(),p(q,null,[s("div",null,[!l.singleThread&&!e($)?(i(),D(e(S),{key:0,class:"float-right",onClick:_[0]||(_[0]=u=>P())},{default:T(()=>[B(m(f.__("New {0}").format(e(J)(l.title))),1)]),_:1})):k("",!0),s("div",be,m(f.__(l.title)),1)]),e(n).data?.length&&!l.singleThread?(i(),p("div",ve,[g.value?(i(!0),p(q,{key:0},L(e(n).data,(u,V)=>(i(),p("div",null,[s("div",{onClick:E=>v(u),class:H(["flex items-center cursor-pointer py-5 w-full",{"border-b":V+1!=e(n).data.length}])},[c(K,{user:u.user,size:"2xl",class:"mr-4"},null,8,["user"]),s("div",null,[s("div",ge,m(u.title),1),s("div",he,[s("span",null,m(u.user.full_name),1),s("span",ke,m(e(A)(u.creation)),1)])])],10,_e)]))),256)):(i(),p("div",Te,[c(j,{topic:y.value,showTopics:g.value,"onUpdate:showTopics":_[1]||(_[1]=u=>g.value=u)},null,8,["topic","showTopics"])]))])):l.singleThread&&e(n).data?(i(),p("div",xe,[c(j,{topic:e(n).data,singleThread:l.singleThread},null,8,["topic","singleThread"])])):(i(),p("div",we,[c(e(se),{class:"w-7 h-7 text-ink-gray-4 stroke-1.5 mr-2"}),s("div",$e,[l.emptyStateTitle?(i(),p("div",Ce,m(f.__(l.emptyStateTitle)),1)):k("",!0),s("div",Se,m(f.__(l.emptyStateText)),1)])])),c(fe,{modelValue:h.value,"onUpdate:modelValue":_[2]||(_[2]=u=>h.value=u),title:f.__("New {0}").format(l.title),doctype:a.doctype,docname:a.docname,reloadTopics:e(n),"onUpdate:reloadTopics":_[3]||(_[3]=u=>oe(n)?n.value=u:null)},null,8,["modelValue","title","doctype","docname","reloadTopics"])],64))}};export{De as _};
//# sourceMappingURL=Discussions-9lwashHD.js.map
